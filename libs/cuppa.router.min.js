//! v0.0.3
export class CuppaRouter{opts;routes=[];callbackSet=new Set;constructor(t){this.opts={root:"",hash:"",resolveAll:!1,titlesMap:{},...t},this.opts.root&&(this.opts.root=`/${this.opts.root}`),this.opts.root||(this.opts.root="/"),window.addEventListener("popstate",this.onHistory.bind(this)),this.setTitle()}updateLinks(t){t||(t=document.querySelectorAll("a:not(.no-router)")),t.forEach((t=>{t.onclick=this.onClick.bind(this)}))}onClick(t){let e=t.currentTarget,a=e.getAttribute("href"),i=e.getAttribute("target"),s=e.getAttribute("title");null!=a&&-1==a.search("http")&&(i&&"_self"!=i||(s&&(this.opts.titlesMap[a]=s),t.preventDefault(),this.setPath(a,s)))}setPath(t,e,a=!0){if(t||(t=(t=(t=document.defaultView.location.href.replace(document.defaultView.location.origin,"")).replace(this.opts.root,"")).replace(this.opts.hash,"")),null!=t&&""!=t||(t=" "),t="#"==t||"/"==t||" "==t?" ":this.opts.hash+t,e||" "!=t||(e=this.opts.titlesMap[""]||this.opts.titlesMap["/"]||this.opts.titlesMap["*"]),!e&&t&&(e=this.opts.titlesMap[t]),null==e&&(e=""),this.setTitle(e,t),a){let a=`${document.defaultView.location.origin}${this.opts.root}${t}`;window.history.pushState(t,e,a)}this.resolve()}getPath(){let t=document.defaultView.location.href;return t=t.replace(document.defaultView.location.origin,""),0===t.indexOf(this.opts.root)&&(t=t.replace(this.opts.root,"")),t=t.replace(this.opts.hash,""),t}setTitle(t,e){e||(e=this.getPath()),e&&(e=e.replace("#/","")),!t&&this.opts.titlesMap&&(t=this.opts.titlesMap[e]),t&&(document.title=t)}onHistory(t){let e=String(t.state)||"";e=e.replace(this.opts.hash,""),this.setPath(e,"",!1)}on(t,e,a={exact:!0,strick:!1}){a={exact:!0,strick:!1,...a},this.routes.push({path:t,callback:e,opts:a})}resolve(t){t||(t=this.getPath());let e=!1;for(let a=0;a<this.routes.length;a++){let i=this.routes[a],s=this.match(t,i.path,i.opts.exact,i.opts.strict);if(s&&i.callback&&(e=!0,i.callback(s)),e&&!this.opts.resolveAll)break}this.callbackSet.forEach((t=>{t(this.getPath())}))}match(t,e,a=!0,i=!1){if(null==e&&(e=this.getPath()),"*"==t)return{path:e};return-1!=e.indexOf("?")&&!1===a&&(e=e.substr(0,e.indexOf("?"))),matchPath(e,{path:t,exact:a,strict:i})}addListener(t){t&&(this.callbackSet.has(t)||this.callbackSet.add(t))}removeListener(t){t&&this.callbackSet.has(t)&&this.callbackSet.delete(t)}getPathData(t){t||(t=this.getPath());let e={url:document.defaultView.location.href};-1!=t.indexOf("?")&&(t=t.substr(0,t.indexOf("?"))),e.path=t,e.pathArray=t.split("/"),e.pathArray=e.pathArray.filter((t=>t)),e.domain=document.defaultView.location.host,e.protocol=document.defaultView.location.protocol,e.port=document.defaultView.location.port;let a=t;if(-1!=a.indexOf("?")||-1!=a.indexOf("#")){-1!=a.indexOf("?")&&(a=a.substr(t.indexOf("?")+1)),-1!=a.indexOf("#")&&(a=a.substr(t.indexOf("#")+1));let i=a.split("&"),s={};for(let t=0;t<i.length;t++){let e=i[t].split("=");e[0]&&(s[e[0]]=e[1]||"")}e.data=s}else e.data={};return e}value(t,e){let a=e=e?"&"+e:this.getPath(),i=new RegExp("[\\?&]"+t+"=([^&#]*)","i").exec(a);return null==i?"":(i=i[1],i=i.replaceAll("%20"," "),i=i.replaceAll("\\+"," "),i)}}document.defaultView.CuppaRouter=CuppaRouter;const cache={},cacheLimit=1e4;let cacheCount=0;function compilePath(t,e){const a=`${e.end}${e.strict}${e.sensitive}`,i=cache[a]||(cache[a]={});if(i[t])return i[t];const s=[],r={regexp:pathToRegexp(t,s,e),keys:s};return cacheCount<1e4&&(i[t]=r,cacheCount++),r}function matchPath(t,e={}){("string"==typeof e||Array.isArray(e))&&(e={path:e});const{path:a,exact:i=!1,strict:s=!1,sensitive:r=!1}=e;return[].concat(a).reduce(((e,a)=>{if(!a&&""!==a)return null;if(e)return e;const{regexp:o,keys:l}=compilePath(a,{end:i,strict:s,sensitive:r}),n=o.exec(t);if(!n)return null;const[c,...h]=n,p=t===c;return i&&!p?null:{path:a,url:"/"===a&&""===c?"/":c,isExact:p,params:l.reduce(((t,e,a)=>(t[e.name]=h[a],t)),{})}}),null)}var PATH_REGEXP=new RegExp(["(\\\\.)","([\\/.])?(?:\\:(\\w+)(?:\\(((?:\\\\.|[^)])*)\\))?|\\(((?:\\\\.|[^)])*)\\))([+*?])?","([.+*?=^!:${}()[\\]|\\/])"].join("|"),"g");function escapeGroup(t){return t.replace(/([=!:$\/()])/g,"\\$1")}var attachKeys=function(t,e){return t.keys=e,t};function pathToRegexp(t,e,a){e&&!Array.isArray(e)&&(a=e,e=null),e=e||[];var i=(a=a||{}).strict,s=!1!==a.end,r=a.sensitive?"":"i",o=0;if(t instanceof RegExp){var l=t.source.match(/\((?!\?)/g)||[];return e.push.apply(e,l.map((function(t,e){return{name:e,delimiter:null,optional:!1,repeat:!1}}))),attachKeys(t,e)}if(Array.isArray(t))return t=t.map((function(t){return pathtoRegexp(t,e,a).source})),attachKeys(new RegExp("(?:"+t.join("|")+")",r),e);var n="/"===(t=t.replace(PATH_REGEXP,(function(t,a,i,s,r,l,n,c){if(a)return a;if(c)return"\\"+c;var h="+"===n||"*"===n,p="?"===n||"*"===n;return e.push({name:s||o++,delimiter:i||"/",optional:p,repeat:h}),i=i?"\\"+i:"",r=escapeGroup(r||l||"[^"+(i||"\\/")+"]+?"),h&&(r=r+"(?:"+i+r+")*"),p?"(?:"+i+"("+r+"))?":i+"("+r+")"})))[t.length-1];return i||(t=(n?t.slice(0,-2):t)+"(?:\\/(?=$))?"),s||(t+=i&&n?"":"(?=\\/|$)"),attachKeys(new RegExp("^"+t+(s?"$":""),r),e)}