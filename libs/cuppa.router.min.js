export class CuppaRouter{opts;routes=[];callbackSet=new Set;constructor(opts){this.opts={root:"",hash:"",resolveAll:!1,titlesMap:{},...opts},this.opts.root||(this.opts.root="/"),window.addEventListener("popstate",this.onHistory.bind(this)),this.setTitle()}updateLinks(elements){elements||(elements=document.querySelectorAll("a:not(.no-router)")),elements.forEach(element=>{element.onclick=this.onClick.bind(this)})}onClick(e){let element=e.currentTarget,path=element.getAttribute("href"),target=element.getAttribute("target"),title=element.getAttribute("title");null!=path&&-1==path.search("http")&&(target&&"_self"!=target||(title&&(this.opts.titlesMap[path]=title),e.preventDefault(),this.setPath(path,title)))}setPath(path,title,addToHistory=!0){if(path||(path=(path=(path=document.defaultView.location.href.replace(document.defaultView.location.origin,"")).replace(this.opts.root,"")).replace(this.opts.hash,"")),null!=path&&""!=path||(path=" "),path="#"==path||"/"==path||" "==path?" ":this.opts.hash+path,title||" "!=path||(title=this.opts.titlesMap[""]||this.opts.titlesMap["/"]||this.opts.titlesMap["*"]),!title&&path&&(title=this.opts.titlesMap[path]),null==title&&(title=""),this.setTitle(title,path),addToHistory){let completePath=`${document.defaultView.location.origin}${this.opts.root}${path}`;window.history.pushState(path,title,completePath)}this.resolve()}getPath(){let path=document.defaultView.location.href;return path=path.replace(document.defaultView.location.origin,""),0===path.indexOf(this.opts.root)&&(path=path.replace(this.opts.root,"")),path=path.replace(this.opts.hash,""),path}setTitle(value,path){path||(path=this.getPath()),path&&(path=path.replace("#/","")),!value&&this.opts.titlesMap&&(value=this.opts.titlesMap[path]),value&&(document.title=value)}onHistory(e){let path=e.state||"";path=path.replace(this.opts.hash,""),this.setPath(path,"",!1)}on(path,callback,opts={exact:!0,strick:!1}){opts={exact:!0,strick:!1,...opts},this.routes.push({path:path,callback:callback,opts:opts})}resolve(path){path||(path=this.getPath());let resolved=!1;for(let i=0;i<this.routes.length;i++){let route=this.routes[i],match=this.match(path,route.path,route.opts.exact,route.opts.strict);if(match&&route.callback&&(resolved=!0,route.callback(match)),resolved&&!this.opts.resolveAll)break}this.callbackSet.forEach(func=>{func(this.getPath())})}match(path,route,exact=!0,strict=!1){if("*"==route)return{path:path};{let match;return matchPath(path,{path:route,exact:exact,strict:strict})}}addListener(func){func&&(this.callbackSet.has(func)||this.callbackSet.add(func))}removeListener(func){func&&this.callbackSet.has(func)&&this.callbackSet.delete(func)}getPathData(path){path||(path=this.getPath());let obj={url:document.defaultView.location.href};-1!=path.indexOf("?")&&(path=path.substr(0,path.indexOf("?"))),obj.path=path,obj.pathArray=path.split("/"),obj.pathArray=obj.pathArray.filter(item=>item),obj.domain=document.defaultView.location.host,obj.protocol=document.defaultView.location.protocol,obj.port=document.defaultView.location.port;let dataStr=path;if(-1!=dataStr.indexOf("?")||-1!=dataStr.indexOf("#")){-1!=dataStr.indexOf("?")&&(dataStr=dataStr.substr(path.indexOf("?")+1)),-1!=dataStr.indexOf("#")&&(dataStr=dataStr.substr(path.indexOf("#")+1));let dataArray=dataStr.split("&"),data={};for(let i=0;i<dataArray.length;i++){let parts=dataArray[i].split("=");parts[0]&&(data[parts[0]]=parts[1]||"")}obj.data=data}else obj.data={};return obj}}window.CuppaRouter=CuppaRouter;const cache={},cacheLimit=1e4;let cacheCount=0;function compilePath(path,options){const cacheKey=`${options.end}${options.strict}${options.sensitive}`,pathCache=cache[cacheKey]||(cache[cacheKey]={});if(pathCache[path])return pathCache[path];const keys=[],regexp=pathToRegexp(path,keys,options),result={regexp:regexp,keys:keys};return cacheCount<1e4&&(pathCache[path]=result,cacheCount++),result}function matchPath(pathname,options={}){("string"==typeof options||Array.isArray(options))&&(options={path:options});const{path:path,exact:exact=!1,strict:strict=!1,sensitive:sensitive=!1}=options,paths=[].concat(path);return paths.reduce((matched,path)=>{if(!path&&""!==path)return null;if(matched)return matched;const{regexp:regexp,keys:keys}=compilePath(path,{end:exact,strict:strict,sensitive:sensitive}),match=regexp.exec(pathname);if(!match)return null;const[url,...values]=match,isExact=pathname===url;return exact&&!isExact?null:{path:path,url:"/"===path&&""===url?"/":url,isExact:isExact,params:keys.reduce((memo,key,index)=>(memo[key.name]=values[index],memo),{})}},null)}var PATH_REGEXP=new RegExp(["(\\\\.)","([\\/.])?(?:\\:(\\w+)(?:\\(((?:\\\\.|[^)])*)\\))?|\\(((?:\\\\.|[^)])*)\\))([+*?])?","([.+*?=^!:${}()[\\]|\\/])"].join("|"),"g");function escapeGroup(group){return group.replace(/([=!:$\/()])/g,"\\$1")}var attachKeys=function(re,keys){return re.keys=keys,re};function pathToRegexp(path,keys,options){keys&&!Array.isArray(keys)&&(options=keys,keys=null),keys=keys||[];var strict=(options=options||{}).strict,end=!1!==options.end,flags=options.sensitive?"":"i",index=0;if(path instanceof RegExp){var groups=path.source.match(/\((?!\?)/g)||[];return keys.push.apply(keys,groups.map((function(match,index){return{name:index,delimiter:null,optional:!1,repeat:!1}}))),attachKeys(path,keys)}if(Array.isArray(path))return path=path.map((function(value){return pathtoRegexp(value,keys,options).source})),attachKeys(new RegExp("(?:"+path.join("|")+")",flags),keys);var endsWithSlash="/"===(path=path.replace(PATH_REGEXP,(function(match,escaped,prefix,key,capture,group,suffix,escape){if(escaped)return escaped;if(escape)return"\\"+escape;var repeat="+"===suffix||"*"===suffix,optional="?"===suffix||"*"===suffix;return keys.push({name:key||index++,delimiter:prefix||"/",optional:optional,repeat:repeat}),prefix=prefix?"\\"+prefix:"",capture=escapeGroup(capture||group||"[^"+(prefix||"\\/")+"]+?"),repeat&&(capture=capture+"(?:"+prefix+capture+")*"),optional?"(?:"+prefix+"("+capture+"))?":prefix+"("+capture+")"})))[path.length-1];return strict||(path=(endsWithSlash?path.slice(0,-2):path)+"(?:\\/(?=$))?"),end||(path+=strict&&endsWithSlash?"":"(?=\\/|$)"),attachKeys(new RegExp("^"+path+(end?"$":""),flags),keys)}